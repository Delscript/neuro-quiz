<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o Neuro-Cognitiva</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { display: block; width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
        input { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 10px; margin-top: 10px; box-sizing: border-box; }
        .screen { display: none; }
        .screen.active { display: block; }
        .option { padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px; cursor: pointer; text-align: left; }
        .option:hover { background: #eff6ff; border-color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <div id="step-lead" class="screen active">
        <h1>Avalia√ß√£o Neuro-Cognitiva</h1>
        <p>Descubra seu perfil exato de QI e QE.</p>
        <p style="font-size:0.9rem; color:#666">üîí Seus dados est√£o seguros.</p>
        <input type="email" id="email" placeholder="Seu melhor e-mail">
        <button class="btn" onclick="app.start()">Iniciar Avalia√ß√£o</button>
    </div>

    <div id="step-quiz" class="screen">
        <p>Pergunta <span id="q-num">1</span> de 19</p>
        <h2 id="q-text">...</h2>
        <div id="q-options"></div>
    </div>

    <div id="step-loading" class="screen">
        <h2>Analisando Perfil...</h2>
        <p>Aguarde enquanto calculamos seu QI e QE.</p>
    </div>

    <div id="step-pay" class="screen">
        <h2 style="color: #10b981">An√°lise Conclu√≠da!</h2>
        <p>Perfil identificado. Libere o relat√≥rio completo e o plano de a√ß√£o.</p>
        <h1 style="color: #2563eb">R$ 19,90</h1>
        <div id="qr-area" style="margin: 20px 0; padding: 20px; background: #f1f5f9; border-radius: 10px;">
            <p>Gerando Pix...</p>
        </div>
        <p style="font-size: 0.8rem; color: #666">Aguardando confirma√ß√£o do banco...</p>
    </div>

    <div id="step-result" class="screen">
        <h1>Seu Relat√≥rio Oficial</h1>
        <div id="final-content"></div>
        <button class="btn" style="background: #25D366" onclick="app.openZap()">Falar com Anderson Dias</button>
    </div>
</div>

<script>
    // --- CONFIGURA√á√ÉO ---
    // Coloque suas chaves DENTRO das aspas abaixo
    const SB_URL = 'https://oabcppkojfmmmqhevjpq.supabase.co'; // Cole a URL do Supabase aqui
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hYmNwcGtvamZtbW1xaGV2anBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTE2ODEsImV4cCI6MjA4NTg4NzY4MX0.b2OlaVmawuwC34kXhLwbJMm6hnPsO7Hng0r8_AHjwhw'; // Cole a Chave ANON aqui

    // --- INICIALIZA√á√ÉO DO SUPABASE ---
    // Usamos 'var' aqui para evitar erro de redeclara√ß√£o se houver cache
    var supabase = null;
    try {
        if (SB_URL && SB_KEY) {
            supabase = window.supabase.createClient(SB_URL, SB_KEY);
        } else {
            console.warn("Chaves ausentes.");
        }
    } catch (e) { console.error(e); }

    const app = {
        data: { email: '', qi: 0, qe: 0, idx: 0, perfil: null },
        
        // Perguntas
        questions: [
            { q: "Qual n√∫mero completa: 2, 4, 8...?", opts: ["16", "12", "10"], type: "QI", c: 0 },
            { q: "Sob press√£o, voc√™...", opts: ["Foca na solu√ß√£o", "Reclama", "Trava"], type: "QE", c: 0 },
            { q: "Se A > B e B > C, ent√£o...", opts: ["A > C", "C > A", "A = C"], type: "QI", c: 0 },
            { q: "Um cliente reclama injustamente. Voc√™...", opts: ["Ouve e resolve", "Discute", "Ignora"], type: "QE", c: 0 },
            { q: "O que pesa mais: 1kg de chumbo ou 1kg de algod√£o?", opts: ["Iguais", "Chumbo", "Algod√£o"], type: "QI", c: 0 },
            { q: "Complete: A Z B Y C ...", opts: ["X", "W", "D"], type: "QI", c: 0 },
            { q: "Em equipe, voc√™ prefere:", opts: ["Liderar", "Seguir", "Fazer sozinho"], type: "QE", c: 0 },
            { q: "Diante de um erro seu:", opts: ["Assume e corrige", "Culpa outro", "Esconde"], type: "QE", c: 0 },
            { q: "Quanto √© 10% de 500?", opts: ["50", "5", "100"], type: "QI", c: 0 },
            { q: "Se ontem fosse amanh√£, hoje seria s√°bado. Que dia √© hoje?", opts: ["Sexta", "Domingo", "Segunda"], type: "QI", c: 2 },
            { q: "Feedback negativo te deixa:", opts: ["Motivado a melhorar", "Com raiva", "Triste"], type: "QE", c: 0 },
            { q: "M√©dico est√° para Hospital como Professor est√° para:", opts: ["Escola", "Aluno", "Giz"], type: "QI", c: 0 },
            { q: "Voc√™ v√™ um colega triste:", opts: ["Pergunta se ajuda", "Ignora", "Riem dele"], type: "QE", c: 0 },
            { q: "Numa negocia√ß√£o, o foco √©:", opts: ["Ganha-Ganha", "Vencer", "N√£o perder"], type: "QE", c: 0 },
            { q: "Carro viaja a 60km/h. Em 3h anda:", opts: ["180km", "120km", "200km"], type: "QI", c: 0 },
            { q: "Intelig√™ncia Emocional √©:", opts: ["Gerir emo√ß√µes", "N√£o ter emo√ß√µes", "Ser feliz sempre"], type: "QE", c: 0 },
            { q: "Qual n√£o pertence?", opts: ["Banana", "Ma√ß√£", "Cadeira"], type: "QI", c: 2 },
            { q: "Para inovar √© preciso:", opts: ["Criatividade", "Dinheiro", "Sorte"], type: "QI", c: 0 },
            { q: "Seu chefe muda tudo de √∫ltima hora:", opts: ["Adapta-se", "Reclama", "Desiste"], type: "QE", c: 0 }
        ],

        start: async () => {
            const email = document.getElementById('email').value;
            if(!email.includes('@')) return alert('E-mail inv√°lido');
            app.data.email = email;
            
            if(supabase) await supabase.from('leads').insert([{ email: email, status_pagamento: 'aguardando' }]);
            app.show('step-quiz');
            app.renderQ();
        },

        renderQ: () => {
            if(app.data.idx >= app.questions.length) return app.finish();
            const q = app.questions[app.data.idx];
            document.getElementById('q-num').innerText = app.data.idx + 1;
            document.getElementById('q-text').innerText = q.q;
            
            const div = document.getElementById('q-options');
            div.innerHTML = '';
            q.opts.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option';
                btn.innerText = opt;
                btn.onclick = () => {
                    if(i === q.c) q.type === 'QI' ? app.data.qi++ : app.data.qe++;
                    app.data.idx++;
                    app.renderQ();
                };
                div.appendChild(btn);
            });
        },

        finish: async () => {
            app.show('step-loading');
            
            // Define Perfil
            let perfilNome = "Em Constru√ß√£o";
            let msg = "Ol√° Anderson, preciso de mentoria.";
            if(app.data.qi > 5 && app.data.qe > 5) { perfilNome = "Pot√™ncia Expansiva"; msg = "Sou Pot√™ncia Expansiva!"; }
            else if(app.data.qi > 5) { perfilNome = "Executor Solit√°rio"; msg = "Sou Executor Solit√°rio."; }
            else if(app.data.qe > 5) { perfilNome = "Conector Nato"; msg = "Sou Conector Nato."; }
            
            app.data.perfil = { nome: perfilNome, msg: msg };
            
            // Atualiza Banco
            if(supabase) {
                await supabase.from('leads').update({ qi_score: app.data.qi, qe_score: app.data.qe }).eq('email', app.data.email);
            }

            app.show('step-pay');
            app.generatePix();
        },

        generatePix: async () => {
            if(!supabase) return alert("Configure as chaves no c√≥digo para gerar o Pix.");
            
            try {
                const { data, error } = await supabase.functions.invoke('gerar-pix', {
                    body: { email: app.data.email, valor: 19.90 }
                });

                if(error || !data) throw error;
                
                document.getElementById('qr-area').innerHTML = `
                    <img src="${data.img}" style="width:200px; mix-blend-mode: multiply;">
                    <p style="word-break:break-all; font-size:0.8rem; border:1px dashed #ccc; padding:10px; background:white; margin:10px 0;">${data.code}</p>
                    <button class="btn" style="background:#333; font-size:0.9rem" onclick="navigator.clipboard.writeText('${data.code}'); alert('Copiado!')">Copiar C√≥digo Pix</button>
                `;
                
                // Monitorar Pagamento
                supabase.channel('pagamento')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leads', filter: `email=eq.${app.data.email}` }, 
                (payload) => {
                    if(payload.new.status_pagamento === 'pago') {
                        app.showResult();
                    }
                }).subscribe();

            } catch(e) {
                console.error(e);
                document.getElementById('qr-area').innerHTML = "<p style='color:red'>Erro ao gerar Pix. Verifique os Logs do Supabase.</p>";
            }
        },

        showResult: () => {
            const p = app.data.perfil;
            document.getElementById('final-content').innerHTML = `
                <h2 style="color:#2563eb">${p.nome}</h2>
                <p>Seu pagamento foi confirmado! Parab√©ns pelo investimento na sua carreira.</p>
                <p>Clique abaixo para agendar sua devolutiva com Anderson Dias.</p>
            `;
            app.show('step-result');
        },

        openZap: () => {
            const zap = "5571999466243"; // SEU N√öMERO
            window.open(`https://wa.me/${zap}?text=${encodeURIComponent(app.data.perfil.msg)}`, '_blank');
        },
        
        show: (id) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };
</script>

</body>
</html>
