<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação Neuro-Cognitiva</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn { display: block; width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
        input { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 10px; margin-top: 10px; box-sizing: border-box; }
        .screen { display: none; }
        .screen.active { display: block; }
        .option { padding: 15px; border: 1px solid #ddd; margin: 10px 0; border-radius: 8px; cursor: pointer; text-align: left; }
        .option:hover { background: #eff6ff; border-color: var(--primary); }
    </style>
</head>
<body>

<div class="container">

    <div id="step-lead" class="screen active">
        <h1>Avaliação Neuro-Cognitiva</h1>
        <p>Descubra seu perfil de QI e QE em 19 perguntas.</p>
        <input type="email" id="email" placeholder="Seu melhor e-mail">
        <button class="btn" onclick="app.start()">Iniciar Avaliação</button>
    </div>

    <div id="step-quiz" class="screen">
        <p>Pergunta <span id="q-num">1</span> de 19</p>
        <h2 id="q-text">...</h2>
        <div id="q-options"></div>
    </div>

    <div id="step-pay" class="screen">
        <h2>Análise Concluída!</h2>
        <p>Seu perfil foi identificado. Libere o relatório completo.</p>
        <h1 style="color: #2563eb">R$ 19,90</h1>
        <div id="qr-area" style="margin: 20px 0; padding: 20px; background: #f1f5f9; border-radius: 10px;">
            <p>Gerando Pix...</p>
        </div>
        <p style="font-size: 0.8rem; color: #666">Aguardando pagamento...</p>
    </div>

    <div id="step-result" class="screen">
        <h1>Seu Relatório</h1>
        <div id="final-content"></div>
        <button class="btn" style="background: #25D366" onclick="app.openZap()">Falar com Especialista</button>
    </div>

</div>

<script>
    // --- CONFIGURAÇÃO ---
    // Coloque suas chaves DENTRO das aspas abaixo
    const SB_URL = 'https://oabcppkojfmmmqhevjpq.supabase.co'; // Cole a URL aqui
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hYmNwcGtvamZtbW1xaGV2anBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTE2ODEsImV4cCI6MjA4NTg4NzY4MX0.b2OlaVmawuwC34kXhLwbJMm6hnPsO7Hng0r8_AHjwhw'; // Cole a chave ANON aqui

    // --- INICIALIZAÇÃO SEGURA ---
    let supabase = null;
    if (SB_URL && SB_KEY) {
        supabase = window.supabase.createClient(SB_URL, SB_KEY);
    } else {
        console.log("Modo sem Supabase (Teste)");
    }

    const app = {
        data: { email: '', qi: 0, qe: 0, idx: 0 },
        
        // PERGUNTAS RESUMIDAS PARA TESTE
        questions: [
            { q: "Qual número completa: 2, 4, 8...?", opts: ["16", "12"], type: "QI", c: 0 },
            { q: "Sob pressão, você...", opts: ["Foca", "Reclama"], type: "QE", c: 0 },
            // (Adicionei apenas 2 para testar rápido, depois você coloca as 19)
        ],

        start: async () => {
            const email = document.getElementById('email').value;
            if(!email.includes('@')) return alert('E-mail inválido');
            app.data.email = email;
            if(supabase) await supabase.from('leads').insert([{ email }]);
            app.show('step-quiz');
            app.renderQ();
        },

        renderQ: () => {
            if(app.data.idx >= app.questions.length) return app.finish();
            const q = app.questions[app.data.idx];
            document.getElementById('q-num').innerText = app.data.idx + 1;
            document.getElementById('q-text').innerText = q.q;
            const div = document.getElementById('q-options');
            div.innerHTML = '';
            q.opts.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option';
                btn.innerText = opt;
                btn.onclick = () => {
                    if(i === q.c) q.type === 'QI' ? app.data.qi++ : app.data.qe++;
                    app.data.idx++;
                    app.renderQ();
                };
                div.appendChild(btn);
            });
        },

        finish: async () => {
            app.show('step-pay');
            if(!supabase) return alert("Adicione as chaves para gerar o Pix!");
            
            try {
                const { data, error } = await supabase.functions.invoke('gerar-pix', {
                    body: { email: app.data.email, valor: 19.90 }
                });
                if(error || !data) throw error;
                
                document.getElementById('qr-area').innerHTML = `
                    <img src="${data.img}" style="width:200px">
                    <p style="word-break:break-all; font-size:0.8rem; border:1px dashed #ccc; padding:10px;">${data.code}</p>
                    <button class="btn" style="margin-top:5px; font-size:0.9rem" onclick="navigator.clipboard.writeText('${data.code}')">Copiar Código</button>
                `;
                
                // OUVINTE DE PAGAMENTO
                supabase.channel('pgto')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leads', filter: `email=eq.${app.data.email}` }, 
                (payload) => {
                    if(payload.new.status_pagamento === 'pago') {
                        document.getElementById('final-content').innerHTML = "<p>Pagamento Confirmado! Seu perfil é: <strong>Potência Expansiva</strong>.</p>";
                        app.show('step-result');
                    }
                }).subscribe();

            } catch(e) {
                document.getElementById('qr-area').innerHTML = "<p style='color:red'>Erro ao conectar com Efí. Verifique as chaves.</p>";
            }
        },

        openZap: () => window.open("https://wa.me/5511999999999", "_blank"),
        show: (id) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };
</script>

</body>
</html>
