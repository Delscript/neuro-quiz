<script>
    // --- ‚öôÔ∏è √ÅREA DE CONFIGURA√á√ÉO ---
    // Coloque suas chaves do Supabase aqui (se j√° estiverem l√°, pode manter)
    
    const SB_URL = 'https://oabcppkojfmmmqhevjpq.supabase.co'; // <--- COLE SUA URL AQUI
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hYmNwcGtvamZtbW1xaGV2anBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTE2ODEsImV4cCI6MjA4NTg4NzY4MX0.b2OlaVmawuwC34kXhLwbJMm6hnPsO7Hng0r8_AHjwhw'; // <--- COLE SUA CHAVE AQUI

    // ---------------------------------------------

    var supabase = null; 
    try {
        if (SB_URL && SB_KEY) {
            if (!window.supabaseClient) window.supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
            supabase = window.supabaseClient;
        }
    } catch (e) { console.error(e); }

    // --- BANCO DE DADOS DE PERFIS (TEXTOS COMPLETOS) ---
    const PERFIS = {
        "Pot√™ncia Expansiva": {
            titulo: "üß† Pot√™ncia Expansiva (O Vision√°rio)",
            resumo: "Voc√™ possui um equil√≠brio raro entre L√≥gica (QI) e Emo√ß√£o (QE).",
            texto: `
                <h3>An√°lise Profunda</h3>
                <p>Seu c√©rebro opera em alta performance tanto na an√°lise de dados quanto na leitura de pessoas. Isso √© encontrado em menos de 5% da popula√ß√£o.</p>
                <p><strong>Pontos Fortes:</strong> Vis√£o estrat√©gica, lideran√ßa natural e capacidade de resolver crises sem perder o controle.</p>
                <p><strong>Seu Ponto Cego:</strong> Voc√™ tende a assumir responsabilidades demais porque acha que "ningu√©m far√° t√£o bem quanto voc√™". Isso gera gargalos na sua empresa.</p>
                <h3>Plano de A√ß√£o</h3>
                <ul>
                    <li><strong>Delega√ß√£o:</strong> Solte o operacional. Sua hora vale muito para ficar resolvendo problemas pequenos.</li>
                    <li><strong>Escala:</strong> Seu foco agora deve ser criar processos para que a empresa ande sozinha.</li>
                </ul>
            `
        },
        "Executor Solit√°rio": {
            titulo: "‚öôÔ∏è Executor Solit√°rio (O T√©cnico)",
            resumo: "Sua capacidade l√≥gica √© brilhante, mas o lado emocional precisa de aten√ß√£o.",
            texto: `
                <h3>An√°lise Profunda</h3>
                <p>Voc√™ √© a pessoa que resolve. Se derem um problema t√©cnico na sua m√£o, voc√™ mata no peito. Por√©m, voc√™ sofre quando precisa lidar com "drama" de funcion√°rios ou clientes.</p>
                <p><strong>Pontos Fortes:</strong> Foco, precis√£o, intelig√™ncia l√≥gica e lealdade.</p>
                <p><strong>Seu Ponto Cego:</strong> Centraliza√ß√£o. Voc√™ acredita que fazer sozinho √© mais r√°pido do que ensinar. Isso limita seu crescimento financeiro.</p>
                <h3>Plano de A√ß√£o</h3>
                <ul>
                    <li><strong>Treinamento:</strong> Dedique 1 hora por dia para treinar algu√©m para ser seu "bra√ßo direito".</li>
                    <li><strong>Comunica√ß√£o:</strong> Aprenda a vender sua vis√£o, n√£o apenas executar tarefas.</li>
                </ul>
            `
        },
        "Conector Nato": {
            titulo: "ü§ù Conector Nato (O Comunicador)",
            resumo: "Voc√™ vende at√© areia no deserto, mas falta organiza√ß√£o e processo.",
            texto: `
                <h3>An√°lise Profunda</h3>
                <p>Sua intelig√™ncia emocional √© alt√≠ssima. As pessoas gostam de voc√™ e confiam em voc√™ rapidamente. O problema √© a execu√ß√£o e a const√¢ncia.</p>
                <p><strong>Pontos Fortes:</strong> Persuas√£o, networking, empatia e vendas.</p>
                <p><strong>Seu Ponto Cego:</strong> Desorganiza√ß√£o. Voc√™ come√ßa 10 projetos e termina 2. Isso faz voc√™ deixar dinheiro na mesa por falta de acompanhamento (follow-up).</p>
                <h3>Plano de A√ß√£o</h3>
                <ul>
                    <li><strong>Processos:</strong> Voc√™ precisa de um CRM ou uma planilha r√≠gida. N√£o confie na cabe√ßa.</li>
                    <li><strong>Parceria:</strong> Busque um s√≥cio ou assistente com perfil "Executor" para organizar sua bagun√ßa criativa.</li>
                </ul>
            `
        },
        "Em Constru√ß√£o": {
            titulo: "üöß Perfil em Desenvolvimento",
            resumo: "Detectamos inconsist√™ncias nas respostas (provavelmente feito r√°pido).",
            texto: `
                <h3>An√°lise Preliminar</h3>
                <p>Suas respostas indicaram uma pontua√ß√£o baixa em ambos os eixos. Isso geralmente acontece quando o teste √© feito com pressa ou sob muita distra√ß√£o.</p>
                <h3>Recomenda√ß√£o</h3>
                <p>Para um diagn√≥stico preciso que possa realmente mudar sua carreira, recomendamos refazer o teste com calma e total sinceridade.</p>
            `
        }
    };

    var app = {
        data: { email: '', qi: 0, qe: 0, idx: 0, perfil: null },
        
        // PERGUNTAS (Mantive as mesmas)
        questions: [
            { q: "Qual n√∫mero completa: 2, 4, 8...?", opts: ["16", "12", "10"], type: "QI", c: 0 },
            { q: "Sob press√£o extrema, voc√™:", opts: ["Foca na solu√ß√£o", "Trava/P√¢nico", "Reclama"], type: "QE", c: 0 },
            { q: "Se A > B e B > C, ent√£o:", opts: ["A > C", "C > A", "A = C"], type: "QI", c: 0 },
            { q: "Cliente gritou com voc√™. Rea√ß√£o:", opts: ["Escuta e resolve", "Grita de volta", "Chora"], type: "QE", c: 0 },
            { q: "O que pesa mais: 1kg chumbo ou 1kg algod√£o?", opts: ["Iguais", "Chumbo", "Algod√£o"], type: "QI", c: 0 },
            { q: "Complete: A, C, E, G...", opts: ["I", "H", "J"], type: "QI", c: 0 },
            { q: "Em grupo, voc√™ prefere:", opts: ["Liderar", "Esperar ordens", "Fazer sozinho"], type: "QE", c: 0 },
            { q: "Erro grave na empresa:", opts: ["Assume e resolve", "Esconde", "Culpa outro"], type: "QE", c: 0 },
            { q: "20% de 500 √©:", opts: ["100", "50", "200"], type: "QI", c: 0 },
            { q: "Se ontem fosse amanh√£, hoje seria s√°bado. Hoje √©:", opts: ["Sexta", "Domingo", "Segunda"], type: "QI", c: 2 },
            { q: "Feedback duro do chefe:", opts: ["Usa pra crescer", "Fica com raiva", "Pede demiss√£o"], type: "QE", c: 0 },
            { q: "M√©dico : Hospital :: Professor : ?", opts: ["Escola", "Aluno", "Giz"], type: "QI", c: 0 },
            { q: "Colega triste. Voc√™:", opts: ["Ajuda discreto", "Ignora", "Faz piada"], type: "QE", c: 0 },
            { q: "Negocia√ß√£o dif√≠cil. Foco em:", opts: ["Acordo m√∫tuo", "Vencer tudo", "N√£o perder"], type: "QE", c: 0 },
            { q: "Carro a 80km/h. Em 30min anda:", opts: ["40km", "80km", "60km"], type: "QI", c: 0 },
            { q: "Intelig√™ncia Emocional √©:", opts: ["Gerir emo√ß√µes", "N√£o sentir", "Ser feliz"], type: "QE", c: 0 },
            { q: "Qual n√£o pertence?", opts: ["Cadeira", "Banana", "Ma√ß√£"], type: "QI", c: 0 },
            { q: "Para inovar precisa de:", opts: ["Resolver dores", "Dinheiro", "Sorte"], type: "QI", c: 0 },
            { q: "Mudan√ßa de planos repentina:", opts: ["Adapta r√°pido", "Reclama", "Trava"], type: "QE", c: 0 }
        ],

        start: async () => {
            const email = document.getElementById('email').value.trim();
            if(!email.includes('@')) return alert('Digite um e-mail v√°lido!');
            app.data.email = email;
            if(supabase) await supabase.from('leads').insert([{ email: email, status_pagamento: 'aguardando' }]);
            app.show('step-quiz');
            app.renderQ();
        },

        renderQ: () => {
            if(app.data.idx >= app.questions.length) return app.finish();
            const q = app.questions[app.data.idx];
            document.getElementById('q-num').innerText = app.data.idx + 1;
            document.getElementById('q-text').innerText = q.q;
            document.getElementById('progress').style.width = ((app.data.idx / app.questions.length) * 100) + '%';
            
            const div = document.getElementById('q-options');
            div.innerHTML = '';
            q.opts.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option';
                btn.innerText = opt;
                btn.onclick = () => {
                    if(i === q.c) q.type === 'QI' ? app.data.qi++ : app.data.qe++;
                    app.data.idx++;
                    app.renderQ();
                };
                div.appendChild(btn);
            });
        },

        finish: async () => {
            app.show('step-loading');
            
            // L√≥gica Inteligente de Perfil
            let chavePerfil = "Em Constru√ß√£o";
            const qi = app.data.qi;
            const qe = app.data.qe;

            if(qi > 6 && qe > 6) chavePerfil = "Pot√™ncia Expansiva";
            else if(qi > 6) chavePerfil = "Executor Solit√°rio";
            else if(qe > 6) chavePerfil = "Conector Nato";
            
            app.data.perfil = PERFIS[chavePerfil]; // Pega o texto completo do banco
            document.getElementById('preview-perfil').innerText = app.data.perfil.titulo;

            if(supabase) await supabase.from('leads').update({ qi_score: qi, qe_score: qe }).eq('email', app.data.email);

            app.generatePix();
        },

        generatePix: async () => {
            try {
                // VALOR: R$ 1.00 para testes (Mude para 19.90 depois)
                const response = await fetch('/api/pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: app.data.email, valor: 1.00 })
                });

                const data = await response.json();
                if(!response.ok) throw new Error(data.erro || 'Erro Vercel');
                
                document.getElementById('qr-area').innerHTML = `
                    <img src="${data.img}" style="width:200px; mix-blend-mode: multiply; display:block; margin:0 auto;">
                    <textarea style="width:100%; font-size:0.8rem; border:1px solid #ccc; padding:10px; margin-top:10px;" rows="3" readonly>${data.code}</textarea>
                    <button class="btn copy-btn" onclick="navigator.clipboard.writeText('${data.code}'); alert('Copiado!')">Copiar C√≥digo Pix</button>
                `;
                
                app.show('step-pay');

                if(supabase) {
                    supabase.channel('pgto_realtime')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leads', filter: `email=eq.${app.data.email}` }, 
                    (payload) => {
                        if(payload.new.status_pagamento === 'pago') app.showResult();
                    }).subscribe();
                }

            } catch(e) {
                console.error(e);
                app.show('step-pay');
                document.getElementById('qr-area').innerHTML = `<p style='color:red'>Erro Pix: ${e.message}</p>`;
            }
        },

        showResult: () => {
            const p = app.data.perfil;
            document.getElementById('final-content').innerHTML = `
                <div style="border: 2px solid #2563eb; padding: 20px; border-radius: 10px; background: #eff6ff;">
                    <h2 style="color: #2563eb; margin-top:0;">${p.titulo}</h2>
                    <p style="font-size: 1.1rem; font-style: italic;">"${p.resumo}"</p>
                    <hr style="border-top: 1px solid #bfdbfe;">
                    <div style="text-align: left;">${p.texto}</div>
                </div>
                <button class="btn" style="background: #333; margin-top: 20px;" onclick="window.print()">üñ®Ô∏è Salvar Relat√≥rio em PDF</button>
            `;
            app.show('step-result');
        },

        openZap: () => window.open("https://wa.me/5571999466243", "_blank"),
        
        show: (id) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };
</script>
