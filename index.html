<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o Neuro-Cognitiva</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --cor-principal: #2563eb; --fundo: #f8fafc; --texto: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fundo); color: var(--texto); padding: 20px; text-align: center; margin: 0; }
        .cx-container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #0f172a; font-size: 1.8rem; }
        .botao-acao { display: block; width: 100%; padding: 16px; background: var(--cor-principal); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .botao-acao:active { transform: scale(0.98); }
        input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 10px; box-sizing: border-box; font-size: 1rem; }
        
        /* Telas */
        .tela-app { display: none; animation: aparecer 0.4s; }
        .tela-app.ativa { display: block; }
        @keyframes aparecer { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Quiz */
        .opcao-quiz { padding: 15px; border: 2px solid #f1f5f9; margin: 10px 0; border-radius: 10px; cursor: pointer; text-align: left; transition: 0.2s; font-weight: 500; }
        .opcao-quiz:hover { background: #eff6ff; border-color: var(--cor-principal); }
        .barra-fundo { width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 20px; }
        .barra-progresso { height: 100%; background: var(--cor-principal); width: 0%; border-radius: 4px; transition: width 0.3s; }
        .caixa-pix { background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px dashed #cbd5e1; margin: 20px 0; word-break: break-all; }

        /* Relat√≥rio */
        .box-relatorio { text-align: left; border: 2px solid #2563eb; padding: 20px; border-radius: 10px; background: #eff6ff; margin-top: 20px; }
        .box-relatorio h2 { color: #2563eb; margin-top: 0; }
        .box-relatorio h3 { color: #1e293b; margin-top: 15px; border-bottom: 1px solid #bfdbfe; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="cx-container">
    
    <div id="tela-inicio" class="tela-app ativa">
        <h1>Avalia√ß√£o Neuro-Cognitiva</h1>
        <p>Descubra seu perfil exato de QI e QE e receba um plano de carreira.</p>
        <div style="background: #ecfdf5; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #065f46; margin-bottom: 20px;">
            üîí Teste Oficial Sier Growth
        </div>
        <input type="email" id="email-usuario" placeholder="Seu melhor e-mail...">
        <button class="botao-acao" onclick="_quizApp.iniciar()">Iniciar Avalia√ß√£o</button>
    </div>

    <div id="tela-perguntas" class="tela-app">
        <div class="barra-fundo"><div id="barra-progresso" class="barra-progresso"></div></div>
        <p style="text-align: right; font-size: 0.8rem; color: #64748b;">Pergunta <span id="num-pergunta">1</span> de <span id="total-perguntas">19</span></p>
        <h2 id="texto-pergunta" style="min-height: 50px;">...</h2>
        <div id="area-opcoes"></div>
    </div>

    <div id="tela-carregando" class="tela-app">
        <div style="font-size: 3rem; margin-bottom: 20px;">üß†</div>
        <h2>Processando Respostas...</h2>
        <p>Cruzando m√©tricas de l√≥gica e intelig√™ncia emocional...</p>
    </div>

    <div id="tela-pagamento" class="tela-app">
        <h2 style="color: #10b981">An√°lise Conclu√≠da!</h2>
        <p>Identificamos um perfil de alto potencial.</p>
        
        <div style="text-align: left; background: #fff; border-left: 4px solid #2563eb; padding: 15px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <p><strong>Seu Perfil Base:</strong> <span id="preview-perfil">Calculando...</span></p>
            <p style="filter: blur(4px); opacity: 0.5;">Sua capacidade de lideran√ßa √© not√°vel, por√©m a gest√£o de tempo...</p>
        </div>

        <h1 style="color: #2563eb; font-size: 2.5rem; margin: 10px 0;">R$ 1,00</h1>
        
        <div id="area-qr" class="caixa-pix">
            <p>Gerando Pix Seguro...</p>
            <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
            <style>@keyframes spin {0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);}}</style>
        </div>
        
        <p style="font-size: 0.8rem; color: #64748b;">Relat√≥rio liberado automaticamente ap√≥s pagamento.</p>
    </div>

    <div id="tela-resultado" class="tela-app">
        <h1 style="color: #2563eb">Relat√≥rio Liberado ‚úÖ</h1>
        <div id="conteudo-final"></div>
        <button class="botao-acao" style="background: #25D366" onclick="_quizApp.abrirZap()">Falar com Especialista</button>
    </div>

</div>

<script>
    // --- ‚öôÔ∏è √ÅREA DE CONFIGURA√á√ÉO (PREENCHA AQUI) ---
    
    // ATEN√á√ÉO: Use a chave "ANON PUBLIC" do Supabase, N√ÉO use a Service Role aqui.
   var _URL_BANCO = "https://oabcppkojfmmmqhevjpq.supabase.co";  
    var _CHAVE_BANCO = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hYmNwcGtvamZtbW1xaGV2anBxIiwicm9 sZSI6ImFub24iLCJpYXQiOjE3NzAzMTE2ODEsImV4cCI6MjA4NTg4NzY4MX0.b2OlaVmawuwC34kXhLwbJMm6hnPsO7Hng0r8_AHjwhw"; 

    // ----------------------------------------------------------

    var _TEXTOS_PERFIL = {
        "Pot√™ncia Expansiva": {
            titulo: "üß† Pot√™ncia Expansiva (O Vision√°rio)",
            resumo: "Equil√≠brio raro entre L√≥gica e Emo√ß√£o.",
            texto: `<h3>An√°lise</h3><p>Seu c√©rebro opera em alta performance. Voc√™ v√™ o que ningu√©m v√™.</p><h3>A√ß√£o</h3><p>Delegue o operacional e foque na estrat√©gia.</p>`
        },
        "Executor Solit√°rio": {
            titulo: "‚öôÔ∏è Executor Solit√°rio (O T√©cnico)",
            resumo: "Alta capacidade l√≥gica, mas centralizador.",
            texto: `<h3>An√°lise</h3><p>Voc√™ resolve tudo, mas sofre por n√£o confiar na equipe.</p><h3>A√ß√£o</h3><p>Treine um bra√ßo direito urgente.</p>`
        },
        "Conector Nato": {
            titulo: "ü§ù Conector Nato (O Comunicador)",
            resumo: "Excelente em vendas, fraco em processos.",
            texto: `<h3>An√°lise</h3><p>Voc√™ abre portas, mas tem dificuldade em fechar ciclos.</p><h3>A√ß√£o</h3><p>Use ferramentas de gest√£o (CRM).</p>`
        },
        "Em Constru√ß√£o": {
            titulo: "üöß Perfil em An√°lise",
            resumo: "Respostas r√°pidas detectadas.",
            texto: `<h3>Diagn√≥stico</h3><p>Refa√ßa o teste com mais calma para um resultado preciso.</p>`
        }
    };

    var _clienteSupabase = null;
    try {
        if (_URL_BANCO && _CHAVE_BANCO && !_URL_BANCO.includes("SUA_URL") && window.supabase) {
            _clienteSupabase = window.supabase.createClient(_URL_BANCO, _CHAVE_BANCO);
        } else {
            console.warn("Supabase n√£o configurado corretamente. O salvamento no banco ser√° ignorado.");
        }
    } catch (e) { console.error("Erro Supabase:", e); }

    var _quizApp = {
        dados: { email: '', qi: 0, qe: 0, idx: 0, perfil: null },
        
        perguntas: [
            { q: "Qual n√∫mero completa: 2, 4, 8...?", opts: ["16", "12", "10"], type: "QI", c: 0 },
            { q: "Sob press√£o extrema, voc√™:", opts: ["Foca na solu√ß√£o", "Trava", "Reclama"], type: "QE", c: 0 },
            { q: "Se A > B e B > C, ent√£o:", opts: ["A > C", "C > A", "A = C"], type: "QI", c: 0 },
            { q: "Cliente gritou. Rea√ß√£o:", opts: ["Resolve calmo", "Grita", "Chora"], type: "QE", c: 0 },
            { q: "O que pesa mais: 1kg chumbo ou algod√£o?", opts: ["Iguais", "Chumbo", "Algod√£o"], type: "QI", c: 0 },
            { q: "Complete: A, C, E, G...", opts: ["I", "H", "J"], type: "QI", c: 0 },
            { q: "Em grupo prefere:", opts: ["Liderar", "Esperar", "Fazer s√≥"], type: "QE", c: 0 },
            { q: "Erro na empresa:", opts: ["Assume", "Esconde", "Culpa outro"], type: "QE", c: 0 },
            { q: "20% de 500 √©:", opts: ["100", "50", "200"], type: "QI", c: 0 },
            { q: "Se ontem fosse amanh√£, hoje seria s√°bado. Hoje √©:", opts: ["Sexta", "Domingo", "Segunda"], type: "QI", c: 2 },
            { q: "Feedback duro:", opts: ["Cresce", "Raiva", "Desiste"], type: "QE", c: 0 },
            { q: "M√©dico : Hospital :: Professor : ?", opts: ["Escola", "Aluno", "Giz"], type: "QI", c: 0 },
            { q: "Colega triste:", opts: ["Ajuda", "Ignora", "Piada"], type: "QE", c: 0 },
            { q: "Negocia√ß√£o:", opts: ["Acordo", "Vencer", "N√£o perder"], type: "QE", c: 0 },
            { q: "Carro 80km/h em 30min:", opts: ["40km", "80km", "60km"], type: "QI", c: 0 },
            { q: "Intelig√™ncia Emocional:", opts: ["Gerir emo√ß√µes", "Nada", "Feliz"], type: "QE", c: 0 },
            { q: "N√£o pertence:", opts: ["Cadeira", "Banana", "Ma√ß√£"], type: "QI", c: 0 },
            { q: "Inovar precisa:", opts: ["Resolver dor", "Dinheiro", "Sorte"], type: "QI", c: 0 },
            { q: "Mudan√ßa repentina:", opts: ["Adapta", "Reclama", "Trava"], type: "QE", c: 0 }
        ],

        iniciar: async () => {
            const emailInput = document.getElementById('email-usuario');
            const email = emailInput.value.trim();
            if(!email.includes('@') || email.length < 5) return alert('Por favor, digite um e-mail v√°lido!');
            
            _quizApp.dados.email = email;
            
            // Tenta salvar, mas n√£o bloqueia se der erro
            if(_clienteSupabase) {
                try {
                    await _clienteSupabase.from('leads').insert([{ email: email, status_pagamento: 'aguardando' }]);
                } catch(e) { console.log("Erro banco (segue o jogo):", e); }
            }
            
            document.getElementById('total-perguntas').innerText = _quizApp.perguntas.length;
            _quizApp.mostrarTela('tela-perguntas');
            _quizApp.renderizar();
        },

        renderizar: () => {
            if(_quizApp.dados.idx >= _quizApp.perguntas.length) return _quizApp.finalizar();
            const q = _quizApp.perguntas[_quizApp.dados.idx];
            document.getElementById('num-pergunta').innerText = _quizApp.dados.idx + 1;
            document.getElementById('texto-pergunta').innerText = q.q;
            document.getElementById('barra-progresso').style.width = ((_quizApp.dados.idx / _quizApp.perguntas.length) * 100) + '%';
            
            const div = document.getElementById('area-opcoes');
            div.innerHTML = '';
            q.opts.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'opcao-quiz';
                btn.innerText = opt;
                btn.onclick = () => {
                    if(i === q.c) q.type === 'QI' ? _quizApp.dados.qi++ : _quizApp.dados.qe++;
                    _quizApp.dados.idx++;
                    _quizApp.renderizar();
                };
                div.appendChild(btn);
            });
        },

        finalizar: async () => {
            _quizApp.mostrarTela('tela-carregando');
            
            // L√≥gica do Perfil
            let chave = "Em Constru√ß√£o";
            if(_quizApp.dados.qi > 6 && _quizApp.dados.qe > 6) chave = "Pot√™ncia Expansiva";
            else if(_quizApp.dados.qi > 6) chave = "Executor Solit√°rio";
            else if(_quizApp.dados.qe > 6) chave = "Conector Nato";
            
            _quizApp.dados.perfil = _TEXTOS_PERFIL[chave];
            document.getElementById('preview-perfil').innerText = _quizApp.dados.perfil.titulo;

            if(_clienteSupabase) {
                try {
                    await _clienteSupabase.from('leads')
                        .update({ qi_score: _quizApp.dados.qi, qe_score: _quizApp.dados.qe })
                        .eq('email', _quizApp.dados.email);
                } catch(e) { console.log("Erro ao atualizar lead:", e); }
            }
            
            setTimeout(() => {
                _quizApp.gerarPix();
            }, 1500);
        },

        gerarPix: async () => {
            try {
                // Envia EMAIL + VALOR + NOTAS (QI/QE) tudo junto
                const res = await fetch('/api/pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: _quizApp.dados.email, 
                        valor: 1.00,
                        qi: _quizApp.dados.qi,
                        qe: _quizApp.dados.qe 
                    })
                });

                if(!res.ok) throw new Error("Falha na API de Pagamento");
                
                const data = await res.json();
                
                if(!data.qrcode_base64 && !data.img) throw new Error("QR Code n√£o recebido");

                const imagemQr = data.qrcode_base64 || data.img;
                
                document.getElementById('area-qr').innerHTML = `
                    <img src="${imagemQr}" style="width:200px; margin:0 auto; display:block; border-radius:8px;">
                    <p style="font-size:0.8rem; margin:10px 0;">Copie e cole no app do banco:</p>
                    <textarea style="width:100%; font-size:0.7rem; background:#eee; border:none; padding:10px; border-radius:5px;" rows="3" readonly>${data.copia_cola || data.code}</textarea>
                    <button class="botao-acao" style="background:#333; margin-top:10px;" onclick="navigator.clipboard.writeText('${data.copia_cola || data.code}');alert('C√≥digo Pix copiado!')">Copiar C√≥digo Pix</button>
                    <div style="font-size:0.7rem; color:#999; margin-top:15px;">ID Transa√ß√£o: ${data.txid}</div>
                    <p style="margin-top:10px; font-size:0.9rem; color:#2563eb; font-weight:bold;">‚è≥ Aguardando confirma√ß√£o...</p>
                `;
                _quizApp.mostrarTela('tela-pagamento');

                _quizApp.monitorarPagamento(data.txid);

            } catch(e) {
                console.error(e);
                _quizApp.mostrarTela('tela-pagamento');
                document.getElementById('area-qr').innerHTML = `
                    <p style="color:red">‚ö†Ô∏è Erro ao gerar Pix.</p>
                    <p style="font-size:0.8rem">${e.message}</p>
                    <button class="botao-acao" onclick="_quizApp.gerarPix()">Tentar Novamente</button>
                `;
            }
        },

        monitorarPagamento: (txid) => {
            if (window.loopVerificacao) clearInterval(window.loopVerificacao);
            
            window.loopVerificacao = setInterval(async () => {
                try {
                    const reqStatus = await fetch('/api/status?txid=' + txid);
                    const jsonStatus = await reqStatus.json();
                    
                    console.log("Status:", jsonStatus.status);

                    if (jsonStatus.status === 'pago' || jsonStatus.status === 'CONCLUIDA') {
                        clearInterval(window.loopVerificacao);
                        _quizApp.mostrarResultado();
                    }
                } catch (erroLoop) {
                    console.log("Aguardando...");
                }
            }, 3000); 
        },

        mostrarResultado: () => {
            const p = _quizApp.dados.perfil;
            document.getElementById('conteudo-final').innerHTML = `
                <div class="box-relatorio">
                    <h2>${p.titulo}</h2>
                    <p><em>"${p.resumo}"</em></p>
                    <div style="display:flex; justify-content:space-around; margin:15px 0; text-align:center;">
                        <div><strong>QI</strong><br><span style="font-size:1.5rem; color:#2563eb">${_quizApp.dados.qi}</span></div>
                        <div><strong>QE</strong><br><span style="font-size:1.5rem; color:#10b981">${_quizApp.dados.qe}</span></div>
                    </div>
                    <hr>${p.texto}
                </div>
                <button class="botao-acao" style="background:#333; margin-top:20px;" onclick="window.print()">üñ®Ô∏è Salvar em PDF</button>
            `;
            _quizApp.mostrarTela('tela-resultado');
        },

        abrirZap: () => window.open("https://wa.me/5571999466243?text=Ol%C3%A1%2C%20fiz%20o%20teste%20Neuro-Cognitivo%20e%20gostaria%20de%20saber%20mais%20sobre%20a%20mentoria.", "_blank"),
        
        mostrarTela: (id) => {
            document.querySelectorAll('.tela-app').forEach(el => el.classList.remove('ativa'));
            document.getElementById(id).classList.add('ativa');
        }
    };
</script>
</body>
</html>
