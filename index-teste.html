<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalia√ß√£o Neuro-Cognitiva</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --cor-principal: #2563eb; --fundo: #f8fafc; --texto: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fundo); color: var(--texto); padding: 20px; text-align: center; margin: 0; }
        .cx-container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { color: #0f172a; font-size: 1.8rem; }
        .botao-acao { display: block; width: 100%; padding: 16px; background: var(--cor-principal); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.2s; }
        .botao-acao:active { transform: scale(0.98); }
        input { width: 100%; padding: 15px; border: 2px solid #e2e8f0; border-radius: 12px; margin-top: 10px; box-sizing: border-box; font-size: 1rem; }
        .tela-app { display: none; animation: aparecer 0.4s; }
        .tela-app.ativa { display: block; }
        @keyframes aparecer { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .opcao-quiz { padding: 15px; border: 2px solid #f1f5f9; margin: 10px 0; border-radius: 10px; cursor: pointer; text-align: left; transition: 0.2s; font-weight: 500; }
        .opcao-quiz:hover { background: #eff6ff; border-color: var(--cor-principal); }
        .barra-fundo { width: 100%; background: #e2e8f0; height: 8px; border-radius: 4px; margin-bottom: 20px; }
        .barra-progresso { height: 100%; background: var(--cor-principal); width: 0%; border-radius: 4px; transition: width 0.3s; }
        .caixa-pix { background: #f8fafc; padding: 20px; border-radius: 12px; border: 2px dashed #cbd5e1; margin: 20px 0; word-break: break-all; }
        .btn-reset { background: transparent; color: #94a3b8; font-size: 0.8rem; margin-top: 20px; border: none; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

<div class="cx-container">
    <div id="tela-inicio" class="tela-app ativa">
        <h1>Avalia√ß√£o Neuro-Cognitiva</h1>
        <p>Descubra seu perfil exato de QI e QE e receba um plano de carreira.</p>
        <div style="background: #ecfdf5; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: #065f46; margin-bottom: 20px;">üîí Teste Oficial Sier Growth</div>
        <input type="text" id="nome-usuario" placeholder="Seu Nome Completo">
        <input type="email" id="email-usuario" placeholder="Seu melhor e-mail...">
        <input type="tel" id="whatsapp-usuario" placeholder="WhatsApp (com DDD)">
        <button class="botao-acao" onclick="_quizApp.iniciar()">Iniciar Avalia√ß√£o</button>
        <button class="btn-reset" onclick="localStorage.clear(); location.reload();">Limpar Cache</button>
    </div>

    <div id="tela-perguntas" class="tela-app">
        <div class="barra-fundo"><div id="barra-progresso" class="barra-progresso"></div></div>
        <p style="text-align: right; font-size: 0.8rem; color: #64748b;">Pergunta <span id="num-pergunta">1</span> de 20</p>
        <h2 id="texto-pergunta" style="min-height: 50px;">...</h2>
        <div id="area-opcoes"></div>
    </div>

    <div id="tela-carregando" class="tela-app">
        <div style="font-size: 3rem; margin-bottom: 20px;">üß†</div>
        <h2>Processando Respostas...</h2>
        <p id="msg-status">Conectando ao banco de dados...</p>
    </div>

    <div id="tela-pagamento" class="tela-app">
        <h2 style="color: #10b981">An√°lise Conclu√≠da!</h2>
        <p style="font-size: 0.9rem; color: #64748b;">Para liberar seu relat√≥rio detalhado, realize o pagamento da taxa simb√≥lica:</p>
        
        <div id="area-qr" class="caixa-pix">Gerando Pix Seguro...</div>
        
        <p id="status-pagamento" style="font-size: 0.9rem; color: #2563eb; font-weight: bold;">‚è≥ Aguardando confirma√ß√£o...</p>
        
        <button class="botao-acao" style="background: #334155; margin-top: 10px; font-size: 0.9rem;" onclick="_quizApp.verAnuncio()">Liberar Gr√°tis (Assistir V√≠deo)</button>
    </div>
</div>

<script>
    // ================= CONFIGURA√á√ÉO =================
    // SUA CHAVE ALEAT√ìRIA
    const CHAVE_PIX_REAL = "65e5f3c3-b7d1-4757-a955-d6fc20519dce"; 
    const NOME_RECEBEDOR = "SIER GROWTH"; // Sem acentos, max 25 chars
    const CIDADE_RECEBEDOR = "SAO PAULO"; // Sem acentos, max 15 chars

    // SUPABASE (Usando a mesma do c√≥digo original)
    const _URL = "https://oabcppkojfmmmqhevjpq.supabase.co"; 
    const _KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hYmNwcGtvamZtbW1xaGV2anBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTE2ODEsImV4cCI6MjA4NTg4NzY4MX0.b2OlaVmawuwC34kXhLwbJMm6hnPsO7Hng0r8_AHjwhw";
    
    // Vari√°vel global segura (meuBanco)
    let meuBanco = null;
    try { 
        if(window.supabase) {
            meuBanco = window.supabase.createClient(_URL, _KEY); 
            console.log("Supabase ok.");
        }
    } catch(e) { console.error("Erro init SB:", e); }

    var _quizApp = {
        dados: { nome: '', email: '', whatsapp: '', qi: 0, qe: 0, idx: 0, fase: 'N√£o Informado', txid: '' },
        
        perguntas: [
            { q: "Qual n√∫mero completa: 2, 4, 8...?", opts: ["16", "12", "10"], type: "QI", c: 0 },
            { q: "Sob press√£o extrema, voc√™:", opts: ["Foca na solu√ß√£o", "Trava", "Reclama"], type: "QE", c: 0 },
            { q: "Se A > B e B > C, ent√£o:", opts: ["A > C", "C > A", "A = C"], type: "QI", c: 0 },
            { q: "Cliente gritou. Rea√ß√£o:", opts: ["Resolve calmo", "Grita", "Chora"], type: "QE", c: 0 },
            { q: "O que pesa mais: 1kg chumbo ou algod√£o?", opts: ["Iguais", "Chumbo", "Algod√£o"], type: "QI", c: 0 },
            { q: "Complete: A, C, E, G...", opts: ["I", "H", "J"], type: "QI", c: 0 },
            { q: "Em grupo prefere:", opts: ["Liderar", "Esperar", "Fazer s√≥"], type: "QE", c: 0 },
            { q: "Erro na empresa:", opts: ["Assume", "Esconde", "Culpa outro"], type: "QE", c: 0 },
            { q: "20% de 500 √©:", opts: ["100", "50", "200"], type: "QI", c: 0 },
            { q: "Se ontem fosse amanh√£, hoje seria s√°bado. Hoje √©:", opts: ["Sexta", "Domingo", "Segunda"], type: "QI", c: 2 },
            { q: "Feedback duro:", opts: ["Cresce", "Raiva", "Desiste"], type: "QE", c: 0 },
            { q: "M√©dico : Hospital :: Professor : ?", opts: ["Escola", "Aluno", "Giz"], type: "QI", c: 0 },
            { q: "Colega triste:", opts: ["Ajuda", "Ignora", "Piada"], type: "QE", c: 0 },
            { q: "Negocia√ß√£o:", opts: ["Acordo", "Vencer", "N√£o perder"], type: "QE", c: 0 },
            { q: "Carro 80km/h em 30min:", opts: ["40km", "80km", "60km"], type: "QI", c: 0 },
            { q: "Intelig√™ncia Emocional:", opts: ["Gerir emo√ß√µes", "Nada", "Feliz"], type: "QE", c: 0 },
            { q: "N√£o pertence:", opts: ["Cadeira", "Banana", "Ma√ß√£"], type: "QI", c: 0 },
            { q: "Inovar precisa:", opts: ["Resolver dor", "Dinheiro", "Sorte"], type: "QI", c: 0 },
            { q: "Mudan√ßa repentina:", opts: ["Adapta", "Reclama", "Trava"], type: "QE", c: 0 },
            { q: "Para calibrar sua lideran√ßa: Qual sua fase atual?", opts: ["Empreendedor/Dono", "Aut√¥nomo/Liberal", "CLT/Colaborador", "Estudante/Outros"], type: "SEG", c: 0 }
        ],

        iniciar: async () => {
            const nome = document.getElementById('nome-usuario').value;
            const email = document.getElementById('email-usuario').value;
            const zap = document.getElementById('whatsapp-usuario').value;
            if(!nome || !email || !zap) return alert('Por favor, preencha todos os campos!');
            
            _quizApp.dados.nome = nome; 
            _quizApp.dados.email = email; 
            _quizApp.dados.whatsapp = zap;
            
            _quizApp.mostrarTela('tela-perguntas');
            _quizApp.renderizar();
        },

        renderizar: () => {
            if(_quizApp.dados.idx >= _quizApp.perguntas.length) return _quizApp.finalizar();
            const q = _quizApp.perguntas[_quizApp.dados.idx];
            document.getElementById('num-pergunta').innerText = _quizApp.dados.idx + 1;
            document.getElementById('texto-pergunta').innerText = q.q;
            document.getElementById('barra-progresso').style.width = ((_quizApp.dados.idx / _quizApp.perguntas.length) * 100) + '%';
            
            const div = document.getElementById('area-opcoes');
            div.innerHTML = '';
            
            q.opts.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'opcao-quiz'; 
                btn.innerText = opt;
                btn.onclick = () => {
                    if(q.type === 'SEG') _quizApp.dados.fase = opt;
                    else if(i === q.c) q.type === 'QI' ? _quizApp.dados.qi++ : _quizApp.dados.qe++;
                    _quizApp.dados.idx++; 
                    _quizApp.renderizar();
                };
                div.appendChild(btn);
            });
        },

        finalizar: async () => {
            _quizApp.mostrarTela('tela-carregando');
            const txid = 'TX-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            _quizApp.dados.txid = txid;

            // Envio para o Banco
            if(meuBanco) {
                try {
                    document.getElementById('msg-status').innerText = "Salvando resultados...";
                    const { error } = await meuBanco.from('leads').insert([{
                        nome: _quizApp.dados.nome,
                        email: _quizApp.dados.email,
                        whatsapp: _quizApp.dados.whatsapp,
                        qi: _quizApp.dados.qi,
                        qe: _quizApp.dados.qe,
                        fase: _quizApp.dados.fase,
                        txid: txid,
                        status: 'pendente'
                    }]);
                    if(error) console.error("Erro BD:", error);
                } catch(e) { console.log("Erro Catch:", e); }
            }

            // Salva Sess√£o
            localStorage.setItem('neuro_sessao_ok', JSON.stringify({
                status: 'pagamento',
                dados: _quizApp.dados
            }));

            _quizApp.mostrarTela('tela-pagamento');
            _quizApp.gerarPixBR(txid);
        },

        gerarPixBR: (txid) => {
            // Gera√ß√£o MANUAL DO PAYLOAD PIX (Com suporte a chave aleat√≥ria)
            // L√≥gica: 0014BR.GOV.BCB.PIX + 01(len)Key
            // Field 26: 00(14)... + 01(len)KEY
            
            const valor = "1.00";
            const chave = CHAVE_PIX_REAL;
            const nome = NOME_RECEBEDOR;
            const cidade = CIDADE_RECEBEDOR;
            
            // Calculando tamanho do campo 26 (Merchant Account Info)
            // 00 + 14 + "BR.GOV.BCB.PIX" (18 chars total)
            // 01 + len(chave) + chave
            const tamChave = chave.length;
            const tamCampo26 = 14 + 4 + 4 + tamChave; // 18 do GUI + 4 do header Chave + tamChave
            // Nota: 14 √© o length do valor do GUI (BR.GOV.BCB.PIX).
            // Estrutura 26: "0014BR.GOV.BCB.PIX" (18 chars) + "01" + len(2 chars) + Chave
            
            const string26 = "0014BR.GOV.BCB.PIX01" + tamChave.toString().padStart(2,'0') + chave;
            
            let payload = "000201";
            payload += "26" + string26.length.toString().padStart(2,'0') + string26;
            payload += "52040000"; // Merchant Category Code
            payload += "5303986";  // BRL
            payload += "54" + valor.length.toString().padStart(2,'0') + valor;
            payload += "5802BR";
            payload += "59" + nome.length.toString().padStart(2,'0') + nome;
            payload += "60" + cidade.length.toString().padStart(2,'0') + cidade;
            
            // Campo 62 (TxID)
            const string62 = "05" + txid.length.toString().padStart(2,'0') + txid;
            payload += "62" + string62.length.toString().padStart(2,'0') + string62;
            
            payload += "6304"; // In√≠cio CRC

            // Calcula CRC16
            const crc = _quizApp.crc16(payload);
            const pixFinal = payload + crc;

            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixFinal)}`;

            document.getElementById('area-qr').innerHTML = `
                <img src="${qrUrl}" style="width:200px; margin:0 auto; display:block; border-radius:10px;">
                <p style="font-size:0.8rem; margin:10px 0;">Valor: <strong>R$ 1,00</strong></p>
                <textarea style="width:100%; font-size:0.7rem; padding:10px; border:1px solid #cbd5e1; border-radius:8px; background:#f1f5f9; color:#333;" rows="3" readonly>${pixFinal}</textarea>
                <button class="botao-acao" style="background:#1e293b; margin-top:10px; padding:12px; font-size:0.9rem;" onclick="navigator.clipboard.writeText('${pixFinal}');alert('Pix Copiado!')">Copiar Pix Copia e Cola</button>
            `;
        },

        verAnuncio: () => {
            window.location.href = `resultado-teste.html?txid=FREE&nome=${encodeURIComponent(_quizApp.dados.nome)}`;
        },

        mostrarTela: (id) => {
            document.querySelectorAll('.tela-app').forEach(el => el.classList.remove('ativa'));
            document.getElementById(id).classList.add('ativa');
        },

        crc16: (payload) => {
            let polinomio = 0x1021;
            let crc = 0xFFFF;
            for (let i = 0; i < payload.length; i++) {
                crc ^= (payload.charCodeAt(i) << 8);
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ polinomio;
                    else crc = crc << 1;
                }
            }
            return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }
    };

    window.onload = () => {
        const sessao = JSON.parse(localStorage.getItem('neuro_sessao_ok'));
        if(sessao && sessao.status === 'pagamento') {
            _quizApp.dados = sessao.dados;
            _quizApp.mostrarTela('tela-pagamento');
            _quizApp.gerarPixBR(sessao.dados.txid);
        }
    };
</script>
</body>
</html>
